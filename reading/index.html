<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- iPad / iOS web-app friendliness -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />

  <title>Reading Practice</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #0b1020;
      color: #e9ecf5;
      -webkit-text-size-adjust: 100%;
      overflow: hidden; /* single-screen */
    }

    button, select, input { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .wrap {
      height: 100vh;
      max-width: 980px; /* portrait iPad */
      margin: 0 auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
    }

    h1 { margin: 0; font-size: 18px; letter-spacing: 0.2px; font-weight: 900; }

    .pill {
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 14px;
      color: rgba(233,236,245,0.95);
      font-weight: 760;
      white-space: nowrap;
    }
    .pill.ok { border-color: rgba(120,255,176,0.55); }

    .panel {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 12px;
    }

    .controls {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 10px;
      align-items: end;
    }

    label { display: grid; gap: 7px; font-size: 13px; color: rgba(233,236,245,0.94); font-weight: 800; }

    select, button {
      background: rgba(0,0,0,0.35);
      color: #e9ecf5;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      outline: none;
      font-size: 16px; /* iOS: prevents auto-zoom */
      min-height: 48px;
    }
    button {
      cursor: pointer;
      font-weight: 900;
      min-height: 52px;
      user-select: none;
      -webkit-user-select: none;
      letter-spacing: 0.2px;
    }
    button.primary { background: rgba(64, 140, 255, 0.42); border-color: rgba(64,140,255,0.80); }
    button:active { transform: translateY(1px); }

    .rowBtns { display:flex; gap:10px; justify-content:flex-end; align-items:center; }
    .rowBtns button { min-width: 108px; }

    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .stats .pill { padding: 8px 10px; font-size: 13px; }

    /* -------- Practice area (big + focused) -------- */
    .practiceCard {
      flex: 1;
      min-height: 0;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      padding: 14px;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .content {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      gap: 10px;
      align-items: start;
    }

    .topRow {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      display:inline-block;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      font-weight: 950;
      letter-spacing: 0.3px;
      opacity: 0.95;
    }

    .readingBox {
      width: 100%;
      border-radius: 18px;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 14px 14px;
      height: 100%;
      overflow: hidden; /* no scroll */
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      align-items: start;
    }

    .titleLine {
      font-weight: 900;
      opacity: 0.95;
      font-size: 14px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline;
    }

    .bigText {
      font-weight: 950;
      letter-spacing: 0.2px;
      line-height: 1.25;
      font-size: clamp(22px, 3.2vw, 34px);
      white-space: pre-wrap;
      word-break: break-word;
      overflow: hidden;
    }
    .bigText.small {
      font-size: clamp(18px, 2.6vw, 28px);
      line-height: 1.22;
    }

    .qaWrap { display:grid; gap:10px; }
    .question { font-size: 18px; font-weight: 950; }
    .choices { display:grid; gap:10px; }
    .choiceBtn {
      text-align:left;
      padding: 14px;
      min-height: 56px;
      border-radius: 16px;
      font-weight: 900;
    }
    .choiceBtn.correct { border-color: rgba(120,255,176,0.55); background: rgba(120,255,176,0.12); }
    .choiceBtn.wrong { border-color: rgba(255,138,161,0.55); background: rgba(255,138,161,0.10); }

    .actions { display:flex; gap:12px; justify-content:center; flex-wrap: wrap; }
    .actions button { min-width: 150px; }

    .feedback { min-height: 30px; text-align:center; font-size: 18px; font-weight: 950; }
    .okText { color: #78ffb0; }
    .badText { color: #ff8aa1; }

    /* Print */
    #printArea { display:none; }
    @media print {
      body { background:#fff; color:#000; overflow: visible; }
      .wrap, header, .panel, .practiceCard { display:none !important; }
      #printArea { display:block !important; }
      #printArea * { color:#000 !important; }

      .pSheet { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 18mm; }
      .pHeader { display:flex; justify-content: space-between; align-items: baseline; gap: 10px; }
      .pTitle { font-size: 16pt; font-weight: 900; }
      .pMeta { font-size: 10.5pt; font-weight: 720; text-align:right; }
      .pLine { border-top: 2px solid #000; margin: 10px 0 12px; }
      .pInfo { display:flex; justify-content: space-between; font-size: 11pt; font-weight: 720; margin-bottom: 10px; }
      .pBlock { margin-bottom: 9mm; }
      .pKind { font-size: 11pt; font-weight: 900; margin-bottom: 2mm; }
      .pText { font-size: 13pt; line-height: 1.4; white-space: pre-wrap; }
      .pQ { margin-top: 3mm; font-size: 11.5pt; font-weight: 900; }
      .pChoice { margin-top: 1.5mm; font-size: 11.5pt; }
      .pBlank { display:inline-block; min-width: 120mm; border-bottom: 2px solid #000; transform: translateY(-2px); }
      .pFooter { margin-top: 10mm; font-size: 10pt; font-weight: 720; display:flex; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>Reading Practice</h1>
      </div>

      <div class="pill" id="clockNow">Time: --:--</div>

      <div style="display:flex; justify-content:flex-end;">
        <div class="pill" id="sessionClock">Session: 0:00</div>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <label>
          Practice type
          <select id="mode">
            <option value="phonics_easy">Phonics – easy</option>
            <option value="phonics_hard">Phonics – difficult</option>
            <option value="words_easy">Words – easy</option>
            <option value="words_hard">Words – difficult</option>
            <option value="sentence_easy">Sentences – easy</option>
            <option value="sentence_hard">Sentences – difficult</option>
            <option value="passage_easy">Passages – easy</option>
            <option value="passage_hard">Passages – difficult</option>
            <option value="mix_easy" selected>Mix – easy</option>
            <option value="mix_hard">Mix – difficult</option>
          </select>
        </label>

        <div style="display:grid; gap:10px;">
          <button class="primary" id="startBtn">Start</button>
          <div class="rowBtns">
            <button id="printBtn">Print</button>
            <button id="clearHistoryBtn">Clear History</button>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="pill" id="statProgress">Worksheet: 0/10</div>
        <div class="pill" id="statAccuracy">Accuracy: 100%</div>
        <div class="pill" id="statAvgTime">Avg time: 0.0s</div>
        <div class="pill" id="statMastery">Mastery: Not yet</div>
      </div>
    </div>

    <div class="practiceCard">
      <div class="content">
        <div class="topRow">
          <span class="badge" id="kindBadge">READY</span>
          <span class="pill" id="itemTitlePill">Item: -</span>
        </div>

        <div class="readingBox">
          <div class="titleLine">
            <span id="itemTitle">Press Start</span>
            <span id="difficultyHint" style="opacity:.88; font-weight:850;"></span>
          </div>
          <div class="bigText" id="readingText">Press Start to begin.</div>

          <div class="qaWrap" id="qaWrap" style="display:none;">
            <div class="question" id="questionText"></div>
            <div class="choices" id="choices"></div>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="markCorrectBtn">Correct</button>
          <button id="markWrongBtn">Incorrect</button>
          <button id="nextBtn">Next</button>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>
    </div>
  </div>

  <div id="printArea"></div>

<script>
(() => {
  const DEFAULT_COUNT = 10; // fixed (no UI)

  // No repeats within or across worksheets (per selected practice type).
  // Persisted to localStorage so reloads do NOT reintroduce repeats.
  // Use Clear History to allow repeats again.
  const usedByMode = Object.create(null); // { [modeKey]: Set<string> }
  const MAX_UNIQUE_TRIES = 4000;
  const STORAGE_KEY = "RP_USED_ITEMS_V1";
  let saveTimer = null;
  let dirtySave = false;

  (function initUsedFromStorage(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;
      for (const [k, arr] of Object.entries(obj)) {
        if (!Array.isArray(arr)) continue;
        usedByMode[k] = new Set(arr.filter(x => typeof x === "string"));
      }
    } catch {}
  })();

  function scheduleSaveUsed(){
    dirtySave = true;
    if (saveTimer) return;
    saveTimer = setTimeout(() => {
      saveTimer = null;
      if (!dirtySave) return;
      dirtySave = false;
      try {
        const out = {};
        for (const [k, set] of Object.entries(usedByMode)) {
          if (set && set.size) out[k] = Array.from(set);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
      } catch {}
    }, 300);
  }

  function getUsedSet(modeKey) {
    if (!usedByMode[modeKey]) usedByMode[modeKey] = new Set();
    return usedByMode[modeKey];
  }

  // ========= CONTENT BANKS (from the original reading practice file) =========
  const WORD_BANK = {
    1: { A:["a","I","see","the","to","and","is","in","it","on","at","we","go","me","my","up","can","like","am","you"],
         B:["with","this","that","have","said","look","come","here","play","from","little","down","help","make","jump","blue","yellow","happy","rain"],
         C:["because","before","after","around","people","friend","family","animal","school","morning","picture","today","tomorrow","together","outside","different"] },
    2: { A:["always","better","suddenly","quiet","laugh","smile","answer","almost","carry","finish","inside","maybe","often","paper","second","simple"],
         B:["between","careful","decide","excited","favorite","follow","garden","happen","listen","middle","perfect","problem","remember","sentence","weather"],
         C:["adventure","building","discover","energy","especially","important","language","measure","practice","protect","question","surprise","whisper","wonder"] },
    3: { A:["compare","complete","curious","direction","example","fraction","imagine","information","notice","pattern","predict","support","topic","unusual"],
         B:["conclusion","concentrate","confidence","environment","excellent","experience","investigate","knowledge","material","opinion","possible","solution","specific"],
         C:["challenge","character","communication","community","experiment","incredible","independent","observation","opportunity","responsible","technology","valuable"] },
    4: { A:["analyze","beneficial","calculate","evidence","function","identify","increase","industry","paragraph","process","research","structure","strategy"],
         B:["consequence","contribute","development","efficient","generation","hypothesis","instrument","interpret","organization","perspective","significant"],
         C:["accomplish","approximately","collaboration","distribution","extraordinary","fundamental","implementation","optimization","productivity","recommendation"] }
  };

  const SENTENCE_TEMPLATES = {
    1: [
      { t:"I see a ___ .", blanks:["cat","dog","hat","bus","sun","cup"] },
      { t:"The ___ is big.", blanks:["dog","tree","ball","fish","kite","cake"] },
      { t:"We can ___ .", blanks:["run","hop","play","read","swim","draw"] },
      { t:"I like the ___ .", blanks:["rain","sun","book","song","game","cake"] }
    ],
    2: [
      { t:"Yesterday we ___ to the park.", blanks:["walked","ran","rode","went"] },
      { t:"Please ___ the directions carefully.", blanks:["follow","read","check","listen to"] },
      { t:"The puppy felt ___ after the nap.", blanks:["happy","better","calm","quiet"] },
      { t:"I can ___ the problem in two steps.", blanks:["solve","finish","explain","check"] }
    ],
    3: [
      { t:"The scientist will ___ the results.", blanks:["analyze","compare","record","explain"] },
      { t:"We noticed a ___ in the data.", blanks:["pattern","change","trend","difference"] },
      { t:"Please ___ your answer with evidence.", blanks:["support","prove","back up","justify"] },
      { t:"The team will ___ a solution together.", blanks:["design","build","test","improve"] }
    ],
    4: [
      { t:"A good paragraph includes a clear ___.", blanks:["topic","purpose","argument","claim"] },
      { t:"Engineers try to ___ a process.", blanks:["optimize","improve","simplify","measure"] },
      { t:"The author explains the ___ of the decision.", blanks:["consequence","impact","result","outcome"] },
      { t:"We should consider a different ___.", blanks:["perspective","approach","strategy","method"] }
    ]
  };

  const PHONICS = {
    1: {
      A: { type:"cvc_blend", sets:[
        { letters:["c","a","t"], correct:"cat", choices:["cat","cot","cut","cap"] },
        { letters:["p","i","n"], correct:"pin", choices:["pan","pin","pen","pun"] },
        { letters:["s","u","n"], correct:"sun", choices:["sin","sun","son","san"] },
        { letters:["m","a","p"], correct:"map", choices:["map","mop","mip","mup"] }
      ]},
      B: { type:"grapheme_sound", sets:[
        { pattern:"sh", prompt:"Tap the word that has “sh”.", correct:"ship", choices:["ship","sip","chip","lip"] },
        { pattern:"ch", prompt:"Tap the word that has “ch”.", correct:"chip", choices:["ship","chip","tip","lip"] },
        { pattern:"th", prompt:"Tap the word that has “th”.", correct:"thin", choices:["tin","thin","shin","fin"] },
        { pattern:"ck", prompt:"Tap the word that has “ck”.", correct:"duck", choices:["duck","duk","dust","dunk"] }
      ]},
      C: { type:"cvc_blend", sets:[
        { letters:["b","a","t"], correct:"bat", choices:["bat","bet","bit","but"] },
        { letters:["f","o","x"], correct:"fox", choices:["fax","fix","fox","fex"] },
        { letters:["r","e","d"], correct:"red", choices:["rid","rod","red","rad"] },
        { letters:["h","o","p"], correct:"hop", choices:["hop","hep","hip","hup"] }
      ]}
    },
    2: {
      A: { type:"blend_cluster", sets:[
        { blend:"st", prompt:"Tap a word that starts with “st”.", correct:"star", choices:["star","car","tar","bar"] },
        { blend:"bl", prompt:"Tap a word that starts with “bl”.", correct:"blue", choices:["blue","glue","clue","flue"] },
        { blend:"cr", prompt:"Tap a word that starts with “cr”.", correct:"crab", choices:["grab","crab","cab","cram"] },
        { blend:"fr", prompt:"Tap a word that starts with “fr”.", correct:"frog", choices:["frog","log","fog","flag"] }
      ]},
      B: { type:"grapheme_sound", sets:[
        { pattern:"ee", prompt:"Tap the word with long e “ee”.", correct:"seed", choices:["sad","seed","sand","said"] },
        { pattern:"oa", prompt:"Tap the word with “oa”.", correct:"boat", choices:["bait","boat","boot","beat"] },
        { pattern:"igh", prompt:"Tap the word with “igh”.", correct:"light", choices:["lift","left","light","late"] },
        { pattern:"ar", prompt:"Tap the word with “ar”.", correct:"farm", choices:["form","from","farm","firm"] }
      ]},
      C: { type:"cvc_blend", sets:[
        { letters:["s","l","a","m"], prompt:"Blend the sounds. Tap the word.", correct:"slam", choices:["slam","slim","slam","slab"] },
        { letters:["t","r","i","p"], prompt:"Blend the sounds. Tap the word.", correct:"trip", choices:["trap","trip","trop","drip"] },
        { letters:["b","r","a","g"], prompt:"Blend the sounds. Tap the word.", correct:"brag", choices:["bag","brag","brag","brig"] },
        { letters:["c","l","a","p"], prompt:"Blend the sounds. Tap the word.", correct:"clap", choices:["cap","clap","clip","clop"] }
      ]}
    },
    3: {
      A: { type:"grapheme_sound", sets:[
        { pattern:"er", prompt:"Tap the word with “er”.", correct:"herd", choices:["hard","heard","herd","hid"] },
        { pattern:"or", prompt:"Tap the word with “or”.", correct:"storm", choices:["steam","storm","starm","stir"] },
        { pattern:"tion", prompt:"Tap the word with “tion”.", correct:"station", choices:["stated","station","staying","staring"] },
        { pattern:"ea", prompt:"Tap the word where “ea” says /ee/.", correct:"each", choices:["each","earn","earth","easy"] }
      ]},
      B: { type:"blend_cluster", sets:[
        { blend:"tr", prompt:"Tap a word that starts with “tr”.", correct:"travel", choices:["travel","ravel","table","trail"] },
        { blend:"spl", prompt:"Tap a word that starts with “spl”.", correct:"splash", choices:["slash","splash","stash","smash"] },
        { blend:"str", prompt:"Tap a word that starts with “str”.", correct:"street", choices:["sweet","street","sheet","steel"] },
        { blend:"scr", prompt:"Tap a word that starts with “scr”.", correct:"screen", choices:["screen","seen","green","scream"] }
      ]},
      C: { type:"morphology", sets:[
        { prompt:"What does “re-” usually mean?", correct:"again", choices:["again","not","small","before"] },
        { prompt:"What does “un-” usually mean?", correct:"not", choices:["not","again","between","under"] },
        { prompt:"What does “-ful” usually mean?", correct:"full of", choices:["full of","past tense","one who","able to"] },
        { prompt:"What does “-less” usually mean?", correct:"without", choices:["without","before","more than","under"] }
      ]}
    },
    4: {
      A: { type:"morphology", sets:[
        { prompt:"“predict” means…", correct:"say before", choices:["say before","say again","say after","say less"] },
        { prompt:"“transport” means…", correct:"carry across", choices:["carry across","carry down","carry back","carry under"] },
        { prompt:"“rebuild” means…", correct:"build again", choices:["build again","build smaller","build under","build before"] },
        { prompt:"“misread” means…", correct:"read wrong", choices:["read wrong","read quickly","read quietly","read first"] }
      ]},
      B: { type:"grapheme_sound", sets:[
        { pattern:"ph", prompt:"Tap the word where “ph” says /f/.", correct:"photo", choices:["photo","piano","phone","pony"] },
        { pattern:"ough", prompt:"Tap the word with “ough”.", correct:"though", choices:["that","then","through","though"] },
        { pattern:"dge", prompt:"Tap the word with “dge”.", correct:"bridge", choices:["bring","bridge","bright","bride"] },
        { pattern:"tion", prompt:"Tap the word with “tion”.", correct:"action", choices:["actor","active","action","acting"] }
      ]},
      C: { type:"morphology", sets:[
        { prompt:"“collaboration” is closest to…", correct:"working together", choices:["working together","working alone","working slowly","working silently"] },
        { prompt:"“inefficient” means…", correct:"not efficient", choices:["not efficient","very efficient","more efficient","almost efficient"] },
        { prompt:"“disagree” means…", correct:"not agree", choices:["not agree","agree quickly","agree again","agree later"] },
        { prompt:"“investigation” is…", correct:"careful study", choices:["careful study","quick guess","loud speech","short story"] }
      ]}
    }
  };

  const PASSAGES = {
    1: [
      { title:"A Rainy Walk", text:"It is raining. Mia puts on her boots. She walks to the door. Splash! The puddle is big. Mia smiles.",
        q:{ question:"Why does Mia put on boots?", choices:["Because it is raining","Because it is snowing","Because it is hot","Because it is dark"], answerIndex:0 } },
      { title:"The Lost Ball", text:"A ball rolls under the couch. Ben looks left and right. He uses a flashlight. He finds the ball and cheers.",
        q:{ question:"Where does the ball roll?", choices:["Under the couch","Into the sink","On the roof","Behind the tree"], answerIndex:0 } },
      { title:"A New Pet", text:"Tara feeds her fish each morning. The fish swims in circles. Tara taps the glass gently. The fish wiggles its tail.",
        q:{ question:"What does Tara do each morning?", choices:["Feeds the fish","Cleans the roof","Paints the glass","Hides the tail"], answerIndex:0 } },
      { title:"Kite Day", text:"The wind is strong. Leo holds the kite string. The kite rises up high. Leo runs and laughs.",
        q:{ question:"What helps the kite go up?", choices:["The wind","The sand","The snow","The puddle"], answerIndex:0 } }
    ],
    2: [
      { title:"The Garden Plan", text:"Lena wants a small garden. She draws a plan on paper. She plants seeds in rows. Each day she waters them and checks for sprouts.",
        q:{ question:"What does Lena do each day?", choices:["Waters the seeds","Moves the rows","Hides the sprouts","Counts the paper"], answerIndex:0 } },
      { title:"A Helpful Neighbor", text:"Mr. Kim carries a heavy box. Maya sees him and offers help. Together they carry it to the porch. Mr. Kim says thank you.",
        q:{ question:"How do they solve the problem?", choices:["They work together","They ignore the box","They break the box","They hide the porch"], answerIndex:0 } },
      { title:"Quiet Corner", text:"In the library, Noor whispers to her friend. They pick a book about space. They sit in a quiet corner and read.",
        q:{ question:"Where do they read?", choices:["In a quiet corner","On a noisy street","Inside a bus","Under a slide"], answerIndex:0 } },
      { title:"Storm Check", text:"Dark clouds fill the sky. Jay checks the weather report. He decides to bring a jacket and stay near home.",
        q:{ question:"Why does Jay bring a jacket?", choices:["Because dark clouds appear","Because the sun is bright","Because the day is hot","Because the sky is clear"], answerIndex:0 } }
    ],
    3: [
      { title:"Testing a Bridge", text:"A class builds a model bridge. First they predict how much weight it can hold. Then they add coins one at a time. They record the number of coins before the bridge bends.",
        q:{ question:"What do they do after making a prediction?", choices:["Add coins one at a time","Paint the bridge blue","Throw away the coins","Stop the test"], answerIndex:0 } },
      { title:"A Pattern in Weather", text:"For two weeks, Amir tracks the weather. He notices that clouds often arrive in the afternoon. He writes this pattern in a notebook and shares it with his class.",
        q:{ question:"What pattern does Amir notice?", choices:["Clouds arrive in the afternoon","Snow falls every night","Rain stops forever","Wind disappears in winter"], answerIndex:0 } },
      { title:"Robot Helper", text:"Kai programs a small robot to follow a line on the floor. The robot sometimes turns too early. Kai changes one setting and tests again. After a few tries, the robot moves smoothly.",
        q:{ question:"How does Kai improve the robot?", choices:["Changes a setting and tests again","Stops testing forever","Unplugs the robot","Moves the floor"], answerIndex:0 } },
      { title:"Recycling Team", text:"A school wants less trash. Students place clear labels on bins. They teach younger kids what goes where. After a month, the school throws away fewer bottles.",
        q:{ question:"What helps reduce trash?", choices:["Labels and teaching","Hiding the bins","Removing labels","Throwing more bottles"], answerIndex:0 } }
    ],
    4: [
      { title:"Improving a System", text:"A library wants shorter wait times. Staff measure how long checkouts take. They rearrange the counter and label shelves clearly. After a week, the average wait time decreases.",
        q:{ question:"What helps reduce wait time?", choices:["Rearranging and labeling clearly","Removing all books","Closing the library","Hiding the shelves"], answerIndex:0 } },
      { title:"Evidence and Claims", text:"A student claims that plants grow faster with more light. She tests two groups of plants, changing only the light. She measures growth and shows the results in a chart.",
        q:{ question:"What makes her claim stronger?", choices:["Testing and measuring results","Guessing the answer","Changing many things at once","Skipping the chart"], answerIndex:0 } },
      { title:"City Buses", text:"A city wants buses to arrive on time. Engineers study traffic at busy intersections. They adjust signal timing and add bus-only lanes on one road. Late arrivals drop.",
        q:{ question:"Which action supports on-time buses?", choices:["Adjusting signals and adding a bus lane","Making roads narrower","Stopping all buses","Removing signals"], answerIndex:0 } },
      { title:"A Careful Investigation", text:"A team tests a new material. They change only one variable at a time. They repeat the test and compare results. This helps them trust the conclusion.",
        q:{ question:"Why change one variable at a time?", choices:["To understand cause and effect","To make results random","To avoid repeating tests","To make it confusing"], answerIndex:0 } }
    ]
  };

  // ========= MODES =========
  const MODES = {
    phonics_easy:  { label:"Phonics – easy",     grades:[1,2], kinds:["phonics"], mastery:{acc:0.90, time:18} },
    phonics_hard:  { label:"Phonics – difficult",grades:[3,4], kinds:["phonics"], mastery:{acc:0.88, time:22} },
    words_easy:    { label:"Words – easy",       grades:[1,2], kinds:["words"],   mastery:{acc:0.90, time:20} },
    words_hard:    { label:"Words – difficult",  grades:[3,4], kinds:["words"],   mastery:{acc:0.88, time:22} },
    sentence_easy: { label:"Sentences – easy",   grades:[1,2], kinds:["sentence"],mastery:{acc:0.88, time:24} },
    sentence_hard: { label:"Sentences – difficult",grades:[3,4],kinds:["sentence"],mastery:{acc:0.85, time:26} },
    passage_easy:  { label:"Passages – easy",    grades:[1,2], kinds:["passage"], mastery:{acc:0.85, time:28} },
    passage_hard:  { label:"Passages – difficult",grades:[3,4],kinds:["passage"], mastery:{acc:0.85, time:32} },
    mix_easy:      { label:"Mix – easy",         grades:[1,2], kinds:["phonics","words","sentence","passage"], mastery:{acc:0.88, time:26} },
    mix_hard:      { label:"Mix – difficult",    grades:[3,4], kinds:["phonics","words","sentence","passage"], mastery:{acc:0.85, time:30} },
  };

  // ========= STATE =========
  const state = {
    current: null,
    started: false,
    setTarget: DEFAULT_COUNT,
    setDone: 0,
    correct: 0,
    total: 0,
    perItemTimes: [],
    itemStartTs: null,
    sessionStartTs: Date.now(),
  };

  // ========= ELEMENTS =========
  const el = {
    mode: document.getElementById("mode"),
    startBtn: document.getElementById("startBtn"),
    printBtn: document.getElementById("printBtn"),
    clearHistoryBtn: document.getElementById("clearHistoryBtn"),

    kindBadge: document.getElementById("kindBadge"),
    itemTitlePill: document.getElementById("itemTitlePill"),
    itemTitle: document.getElementById("itemTitle"),
    difficultyHint: document.getElementById("difficultyHint"),
    readingText: document.getElementById("readingText"),

    qaWrap: document.getElementById("qaWrap"),
    questionText: document.getElementById("questionText"),
    choices: document.getElementById("choices"),

    feedback: document.getElementById("feedback"),
    markCorrectBtn: document.getElementById("markCorrectBtn"),
    markWrongBtn: document.getElementById("markWrongBtn"),
    nextBtn: document.getElementById("nextBtn"),

    statProgress: document.getElementById("statProgress"),
    statAccuracy: document.getElementById("statAccuracy"),
    statAvgTime: document.getElementById("statAvgTime"),
    statMastery: document.getElementById("statMastery"),
    sessionClock: document.getElementById("sessionClock"),
    clockNow: document.getElementById("clockNow"),

    printArea: document.getElementById("printArea"),
  };

  // ========= HELPERS =========
  const randInt = (min,maxInc) => Math.floor(Math.random()*(maxInc-min+1))+min;

  function setFeedback(msg, kind) {
    el.feedback.textContent = msg || "";
    el.feedback.className = "feedback " + (kind || "");
  }

  function computeAvgTime() {
    if (!state.perItemTimes.length) return 0;
    const sum = state.perItemTimes.reduce((a,b)=>a+b,0);
    return sum / state.perItemTimes.length;
  }

  function getModeKey() { return el.mode.value || "mix_easy"; }
  function getModeObj(key=getModeKey()) { return MODES[key] || MODES.mix_easy; }

  function signatureForItem(item) {
    // For repeat prevention, treat an item as the pair (kind, text, question+choices).
    // Keep it deterministic and stable.
    const kind = item.kind || "";
    const title = item.title || "";
    const text = item.text || "";
    let q = "";
    if (item.question) {
      const qq = item.question;
      const qText = qq.question || "";
      const choices = Array.isArray(qq.choices) ? qq.choices.join("|") : "";
      const ai = (typeof qq.answerIndex === "number") ? String(qq.answerIndex) : "";
      q = `Q:${qText}|C:${choices}|A:${ai}`;
    }
    // Compact signature
    return `${kind}#${title}#${text}#${q}`;
  }

  function generateUniqueItem(modeKey) {
    const used = getUsedSet(modeKey);
    for (let i = 0; i < MAX_UNIQUE_TRIES; i++) {
      const it = generateItemForMode(modeKey);
      const sig = signatureForItem(it);
      if (!used.has(sig)) {
        used.add(sig);
        scheduleSaveUsed();
        return it;
      }
    }
    return null;
  }

  function updateStats() {
    el.statProgress.textContent = `Worksheet: ${state.setDone}/${state.setTarget}`;
    const acc = state.total ? Math.round((state.correct / state.total) * 100) : 100;
    el.statAccuracy.textContent = `Accuracy: ${acc}%`;
    el.statAvgTime.textContent = `Avg time: ${computeAvgTime().toFixed(1)}s`;

    const mastery = checkMastery(false);
    el.statMastery.textContent = mastery.passed ? "Mastery: PASS" : "Mastery: Not yet";
    el.statMastery.className = "pill " + (mastery.passed ? "ok" : "");
  }

  function clearChoices() {
    el.choices.innerHTML = "";
    el.qaWrap.style.display = "none";
  }
  function lockChoices() {
    Array.from(el.choices.querySelectorAll("button")).forEach(b => b.disabled = true);
  }

  // ========= ITEM GENERATORS =========
  function pickGrade(grades) { return grades[randInt(0, grades.length-1)]; }

  function makeWordsItem(grade) {
    const letters = Object.keys(WORD_BANK[grade] || {A:[]});
    const letter = letters[randInt(0, letters.length-1)] || "A";
    const pool = (WORD_BANK[grade] && WORD_BANK[grade][letter]) ? WORD_BANK[grade][letter] : (WORD_BANK[grade] ? WORD_BANK[grade].A : []);

    const count = grade <= 2 ? 8 : 10;
    const picked = [];
    for (let i=0; i<count; i++) picked.push(pool[randInt(0, pool.length-1)]);
    return { kind:"words", title:"Word Fluency", text:picked.join("   "), question:null };
  }

  function makeSentenceItem(grade) {
    const templ = SENTENCE_TEMPLATES[grade][randInt(0, SENTENCE_TEMPLATES[grade].length-1)];
    const correct = templ.blanks[randInt(0, templ.blanks.length-1)];
    const distract = [];
    const all = templ.blanks.slice();
    while (distract.length < 3) {
      const w = all[randInt(0, all.length-1)];
      if (w !== correct && !distract.includes(w)) distract.push(w);
    }
    const choices = [correct, ...distract].sort(() => Math.random() - 0.5);
    return {
      kind:"sentence",
      title:"Sentence Meaning",
      text: templ.t.replace("___", "_____"),
      question: { question:"Choose the best word to fill the blank.", choices, answerIndex: choices.indexOf(correct) }
    };
  }

  function makePassageItem(grade) {
    const p = PASSAGES[grade][randInt(0, PASSAGES[grade].length-1)];
    return {
      kind:"passage",
      title: p.title,
      text: p.text,
      question: { question: p.q.question, choices: p.q.choices.slice(), answerIndex: p.q.answerIndex }
    };
  }

  function makePhonicsItem(grade) {
    const letters = Object.keys(PHONICS[grade] || {A:null});
    const letter = letters[randInt(0, letters.length-1)] || "A";
    const block = PHONICS[grade][letter] || PHONICS[grade]["A"];
    const set = block.sets[randInt(0, block.sets.length-1)];
    const kind = "phonics";

    if (block.type === "cvc_blend") {
      const lettersArr = set.letters || [];
      const prompt = set.prompt || "Blend the sounds. Tap the word.";
      const text = lettersArr.join(" - ");
      const answerIndex = set.choices.indexOf(set.correct);
      return { kind, title:"Phonics Blend", text, question:{ question: prompt, choices:set.choices.slice(), answerIndex } };
    }
    if (block.type === "grapheme_sound") {
      const text = `Pattern: ${set.pattern}`;
      const answerIndex = set.choices.indexOf(set.correct);
      return { kind, title:"Phonics Pattern", text, question:{ question: set.prompt, choices:set.choices.slice(), answerIndex } };
    }
    if (block.type === "blend_cluster") {
      const text = `Blend: ${set.blend}`;
      const answerIndex = set.choices.indexOf(set.correct);
      return { kind, title:"Phonics Blends", text, question:{ question: set.prompt, choices:set.choices.slice(), answerIndex } };
    }
    // morphology
    const text = "Word Parts";
    const answerIndex = set.choices.indexOf(set.correct);
    return { kind, title:"Word Parts", text, question:{ question: set.prompt, choices:set.choices.slice(), answerIndex } };
  }

  function generateItemForMode(modeKey) {
    const m = getModeObj(modeKey);
    const grade = pickGrade(m.grades);
    const kind = m.kinds[randInt(0, m.kinds.length-1)];

    if (kind === "phonics") return makePhonicsItem(grade);
    if (kind === "words") return makeWordsItem(grade);
    if (kind === "sentence") return makeSentenceItem(grade);
    return makePassageItem(grade);
  }

  // ========= RENDERING =========
  function applyTextSizing(text) {
    const long = (text || "").length > 160;
    el.readingText.classList.toggle("small", long);
  }

  function renderItem(item) {
    state.current = item;

    el.kindBadge.textContent =
      item.kind === "phonics" ? "PHONICS" :
      item.kind === "words" ? "WORDS" :
      item.kind === "sentence" ? "SENTENCE" : "PASSAGE";

    el.itemTitlePill.textContent = `Item: ${item.title}`;
    el.itemTitle.textContent = item.title;
    el.difficultyHint.textContent = getModeObj().label;

    el.readingText.textContent = item.text;
    applyTextSizing(item.text);

    clearChoices();

    if (item.question) {
      el.qaWrap.style.display = "block";
      el.questionText.textContent = item.question.question;

      item.question.choices.forEach((c, idx) => {
        const b = document.createElement("button");
        b.className = "choiceBtn";
        b.textContent = c;
        b.addEventListener("click", () => pickChoice(idx));
        el.choices.appendChild(b);
      });

      setFeedback("Tap an answer.", "");
    } else {
      setFeedback("Read out loud. Then tap Correct or Incorrect.", "");
    }
  }

  function pickChoice(idx) {
    const item = state.current;
    if (!item || !item.question) return;

    lockChoices();
    const correctIdx = item.question.answerIndex;
    const isCorrect = idx === correctIdx;

    Array.from(el.choices.children).forEach((btn, i) => {
      if (i === correctIdx) btn.classList.add("correct");
      if (i === idx && !isCorrect) btn.classList.add("wrong");
    });

    finalizeItem(isCorrect, true);
  }

  // ========= WORKSHEET FLOW =========
  function startWorksheet() {
    state.started = true;
    state.setTarget = DEFAULT_COUNT;
    state.setDone = 0;
    state.correct = 0;
    state.total = 0;
    state.perItemTimes = [];
    state.itemStartTs = null;

    nextItem(true);
    updateStats();
  }

  function nextItem(isNew=false) {
    if (!state.started) return;

    if (!isNew && state.setDone >= state.setTarget) {
      checkMastery(true);
      updateStats();

      el.kindBadge.textContent = "DONE";
      el.itemTitlePill.textContent = "Item: -";
      el.itemTitle.textContent = "Worksheet done!";
      el.readingText.textContent = "Nice work. Press Start to begin a new worksheet.";
      el.readingText.classList.remove("small");
      clearChoices();
      setFeedback("Worksheet complete.", "okText");
      state.current = null;
      return;
    }

    const modeKey = getModeKey();
    const item = generateUniqueItem(modeKey);
    if (!item) {
      el.kindBadge.textContent = "EXHAUSTED";
      el.itemTitlePill.textContent = "Item: -";
      el.itemTitle.textContent = "No more unique items";
      el.readingText.textContent = "Switch practice type or tap Clear History.";
      el.readingText.classList.remove("small");
      clearChoices();
      setFeedback("", "");
      state.current = null;
      return;
    }
    renderItem(item);
    state.itemStartTs = performance.now();

    updateStats();
  }

  function finalizeItem(isCorrect, fromChoice=false) {
    if (!state.current) return;

    const dt = state.itemStartTs ? (performance.now() - state.itemStartTs) / 1000 : 0;
    state.total += 1;
    state.perItemTimes.push(dt);
    state.setDone += 1;

    if (isCorrect) {
      state.correct += 1;
      setFeedback("Correct.", "okText");
    } else {
      setFeedback("Not quite.", "badText");
    }

    updateStats();
    setTimeout(() => nextItem(false), fromChoice ? 520 : 360);
  }

  function checkMastery(showMessage) {
    const m = getModeObj();
    const acc = state.total ? (state.correct / state.total) : 1;
    const avg = computeAvgTime();
    const enoughAttempts = state.total >= Math.min(state.setTarget, 6);
    const passed = enoughAttempts && acc >= m.mastery.acc && avg > 0 && avg <= m.mastery.time;

    if (showMessage) {
      if (passed) setFeedback("Mastery PASS.", "okText");
      else setFeedback("Keep going.", "");
    }
    return { passed, acc, avg };
  }


  function clearHistory() {
    const ok = window.confirm("Clear saved item history? This allows repeats again.");
    if (!ok) return;

    for (const k of Object.keys(usedByMode)) delete usedByMode[k];
    try { localStorage.removeItem(STORAGE_KEY); } catch {}

    // Reset session stats and worksheet state
    state.current = null;
    state.started = false;
    state.setDone = 0;
    state.correct = 0;
    state.total = 0;
    state.perItemTimes = [];
    state.itemStartTs = null;

    el.kindBadge.textContent = "READY";
    el.itemTitlePill.textContent = "Item: -";
    el.itemTitle.textContent = "Press Start";
    el.readingText.textContent = "Press Start to begin.";
    el.readingText.classList.remove("small");
    clearChoices();
    setFeedback("History cleared.", "");
    updateStats();
  }

  // ========= PRINT =========
  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function buildPrintItems(count) {
    const key = getModeKey();
    const items = [];
    for (let i=0; i<count; i++) {
      const it = generateUniqueItem(key);
      if (!it) break;
      items.push(it);
    }
    return items;
  }

  function renderPrintItemHTML(item, idx) {
    const kind = item.kind.toUpperCase();
    const title = item.title || kind;
    const safeText = (item.text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    let qHtml = "";
    if (item.question) {
      const q = item.question;
      const safeQ = (q.question || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      qHtml += `<div class="pQ">Q: ${safeQ}</div>`;
      q.choices.forEach((c, i) => {
        const safeC = String(c).replace(/</g,"&lt;").replace(/>/g,"&gt;");
        qHtml += `<div class="pChoice">(${String.fromCharCode(65+i)}) ${safeC}</div>`;
      });
      qHtml += `<div style="margin-top:2mm;">Answer: <span class="pBlank"></span></div>`;
    } else {
      qHtml += `<div style="margin-top:2mm;">Notes: <span class="pBlank"></span></div>`;
    }

    return `
      <div class="pBlock">
        <div class="pKind">${idx+1}. ${kind} • ${title}</div>
        <div class="pText">${safeText}</div>
        ${qHtml}
      </div>
    `;
  }

  function renderPrintSheet() {
    const m = getModeObj();
    const count = DEFAULT_COUNT;
    const items = buildPrintItems(count);
    const actualCount = items.length;
    const dateStr = todayISO();

    const blocks = items.map((it, idx) => renderPrintItemHTML(it, idx)).join("");

    el.printArea.innerHTML = `
      <div class="pSheet">
        <div class="pHeader">
          <div class="pTitle">Reading Worksheet</div>
          <div class="pMeta">Date: ${dateStr}<br/>${m.label}</div>
        </div>
        <div class="pLine"></div>
        <div class="pInfo">
          <div>Name: __________________________</div>
          <div>Time: _____________   Score: ______ / ${actualCount}</div>
        </div>
        ${blocks}
        <div class="pFooter">
          <div>Read clearly and think carefully.</div>
          <div>${m.label}</div>
        </div>
      </div>
    `;
  }

  function printWorksheet() {
    renderPrintSheet();
    setTimeout(() => window.print(), 50);
  }

  // ========= EVENTS =========
  el.startBtn.addEventListener("click", startWorksheet);
  el.printBtn.addEventListener("click", printWorksheet);
  el.clearHistoryBtn.addEventListener("click", clearHistory);

  el.markCorrectBtn.addEventListener("click", () => finalizeItem(true, false));
  el.markWrongBtn.addEventListener("click", () => finalizeItem(false, false));
  el.nextBtn.addEventListener("click", () => nextItem(false));

  el.mode.addEventListener("change", () => {
    updateStats();
    if (state.started) startWorksheet();
  });

  // Session timer (right)
  setInterval(() => {
    const s = Math.floor((Date.now() - state.sessionStartTs) / 1000);
    const mm = Math.floor(s / 60);
    const ss = String(s % 60).padStart(2, "0");
    el.sessionClock.textContent = `Session: ${mm}:${ss}`;
  }, 500);

  // Current time (top center) - hour:minute only
  const fmt = new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" });
  function tickNow() { el.clockNow.textContent = `Time: ${fmt.format(new Date())}`; }
  tickNow();
  setInterval(tickNow, 1000);

  // Init
  updateStats();
  el.kindBadge.textContent = "READY";
  el.itemTitlePill.textContent = "Item: -";
  el.itemTitle.textContent = "Press Start";
  el.difficultyHint.textContent = getModeObj().label;
  setFeedback("", "");
})();
</script>
</body>
</html>
