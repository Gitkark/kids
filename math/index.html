<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- iPad / iOS web-app friendliness -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />

  <title>Math Practice</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #0b1020;
      color: #e9ecf5;
      -webkit-text-size-adjust: 100%;
      overflow: hidden; /* fit one screen */
    }

    button, select, input { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .wrap {
      height: 100vh;
      max-width: 980px; /* portrait iPad feels better */
      margin: 0 auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
    }

    h1 { margin: 0; font-size: 18px; letter-spacing: 0.2px; font-weight: 900; }

    .pill {
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 14px;
      color: rgba(233,236,245,0.95);
      font-weight: 750;
      white-space: nowrap;
    }
    .pill.ok { border-color: rgba(120,255,176,0.55); }

    .panel {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 12px;
    }

    .controls {
      display: grid;
      grid-template-columns: 1.35fr 1fr;
      gap: 10px;
      align-items: end;
    }

    label { display: grid; gap: 7px; font-size: 13px; color: rgba(233,236,245,0.94); font-weight: 800; }

    select, button, input[type="text"] {
      background: rgba(0,0,0,0.35);
      color: #e9ecf5;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      outline: none;
      font-size: 16px; /* iOS: prevents auto-zoom */
    }

    select { min-height: 48px; }
    button {
      cursor: pointer;
      font-weight: 900;
      min-height: 52px;
      user-select: none;
      -webkit-user-select: none;
      letter-spacing: 0.2px;
    }
    button.primary { background: rgba(64, 140, 255, 0.42); border-color: rgba(64,140,255,0.80); }
    button:active { transform: translateY(1px); }

    .rowBtns { display:flex; gap:10px; justify-content:flex-end; align-items: center; }
    .rowBtns button { min-width: 108px; }

    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .stats .pill { padding: 8px 10px; font-size: 13px; }

    /* -------- Practice area (big + focused) -------- */
    .practiceCard {
      flex: 1;
      min-height: 0;     /* allow flexbox to size without overflow */
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      padding: 16px 14px;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .kumon {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items: center;
      justify-items: center;
      width: 100%;
    }

    .equationHorizontal {
      font-size: clamp(54px, 7.2vw, 92px);
      letter-spacing: 1px;
      font-weight: 950;
      line-height: 1.02;
      text-align: center;
      margin: 0;
    }

    .equationVerticalWrap { display: grid; place-items: center; width: 100%; }
    .equationVertical {
      font-size: clamp(54px, 7.2vw, 92px);
      font-weight: 950;
      line-height: 1.02;
      letter-spacing: 1px;
      text-align: right;
      padding: 12px 16px 14px 16px;
      border-radius: 18px;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.12);
      min-width: min(520px, 92vw);
    }
    .vrow { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .vbottom {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 14px;
      align-items: center;
      padding-right: 6px;
    }
    .vopLeft { text-align: left; min-width: 1ch; }
    .vnumRight { text-align: right; }
    .vline { height: 2px; background: rgba(233,236,245,0.86); border-radius: 2px; margin: 2px 0; }

    .answerRow {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    #answer {
      width: min(300px, 80vw);
      text-align: center;
      font-size: clamp(24px, 3.2vw, 40px);
      padding: 12px 14px;
      font-weight: 950;
      min-height: 54px;
    }
    #checkBtn { min-width: 140px; }
    #nextBtn { min-width: 110px; }

    .feedback { min-height: 32px; text-align: center; font-size: 18px; font-weight: 950; }
    .okText { color: #78ffb0; }
    .badText { color: #ff8aa1; }

    /* -------- Printable worksheet area (hidden on screen) -------- */
    #printArea { display:none; }
    @media print {
      body { background: #fff; color: #000; overflow: visible; }
      .wrap, header, .panel, .practiceCard, .stats { display:none !important; }
      #printArea { display:block !important; }
      #printArea * { color:#000 !important; }

      .pSheet { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 18mm; }
      .pHeader { display:flex; justify-content: space-between; align-items: baseline; gap: 10px; }
      .pTitle { font-size: 16pt; font-weight: 900; }
      .pMeta { font-size: 10.5pt; font-weight: 700; text-align:right; }
      .pLine { border-top: 2px solid #000; margin: 10px 0 12px; }
      .pInfo { display:flex; justify-content: space-between; font-size: 11pt; font-weight: 700; margin-bottom: 10px; }
      .pGrid { display:grid; grid-template-columns: 1fr 1fr; gap: 10mm 14mm; }

      .pProbH { font-size: 18pt; font-weight: 800; letter-spacing: 0.4px; }
      .pBlank { display:inline-block; min-width: 40mm; border-bottom: 2px solid #000; transform: translateY(-2px); }

      .pProbV { font-size: 18pt; font-weight: 900; letter-spacing: 0.4px; display: inline-block; min-width: 52mm; }
      .pVRow { display:flex; justify-content:flex-end; }
      .pVRow.op { display:grid; grid-template-columns: auto 1fr; gap: 6mm; align-items: baseline; }
      .pVRow.op .opLeft { justify-self: start; }
      .pVRow.op .numRight { justify-self: end; }
      .pVLine { border-top: 2px solid #000; margin: 2mm 0 2mm; }
      .pVAnswer { display:flex; justify-content:flex-end; }
      .pVBlank { display:inline-block; min-width: 42mm; border-bottom: 2px solid #000; height: 0; }

      .pFooter { margin-top: 10mm; font-size: 10pt; font-weight: 700; display:flex; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>Math Practice</h1>
      </div>

      <div class="pill" id="clockNow">Time: --:--</div>

      <div style="display:flex; justify-content:flex-end;">
        <div class="pill" id="sessionClock">Session: 0:00</div>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <label>
          Problem type
          <select id="ptype">
            <option value="add_easy">Addition – easy</option>
            <option value="add_hard">Addition – difficult</option>
            <option value="sub_easy">Subtraction – easy</option>
            <option value="sub_hard">Subtraction – difficult</option>
            <option value="mul_easy">Multiplication – easy</option>
            <option value="mul_hard">Multiplication – difficult</option>
            <option value="div_easy">Division – easy</option>
            <option value="div_hard">Division – difficult</option>
            <option value="mix_easy" selected>Mix – easy</option>
            <option value="mix_hard">Mix – difficult</option>
          </select>
        </label>

        <div style="display:grid; gap:10px;">
          <button class="primary" id="startBtn">Start</button>
          <div class="rowBtns">
            <button id="printBtn">Print</button>
            <button id="clearHistoryBtn">Clear History</button>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="pill" id="statProgress">Worksheet: 0/20</div>
        <div class="pill" id="statStreak">Streak: 0</div>
        <div class="pill" id="statAccuracy">Accuracy: 100%</div>
        <div class="pill" id="statAvgTime">Avg time: 0.0s</div>
        <div class="pill" id="statLayout">Layout: Mixed</div>
        <div class="pill" id="statMastery">Mastery: Not yet</div>
      </div>
    </div>

    <div class="practiceCard">
      <div class="kumon">
        <div id="equationHorizontal" class="equationHorizontal" style="display:none;">Press Start</div>

        <div id="equationVerticalWrap" class="equationVerticalWrap" style="display:none;">
          <div class="equationVertical">
            <div class="vrow">
              <div id="vTop" style="padding-right:6px;"></div>
              <div class="vbottom">
                <div id="vOp" class="vopLeft"></div>
                <div id="vBottom" class="vnumRight"></div>
              </div>
              <div class="vline"></div>
            </div>
          </div>
        </div>

        <div class="answerRow">
          <input id="answer"
                 type="text"
                 inputmode="numeric"
                 autocomplete="off"
                 placeholder="Answer"
                 enterkeyhint="done" />
          <button class="primary" id="checkBtn">Check</button>
          <button id="nextBtn">Next</button>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>
    </div>
  </div>

  <div id="printArea"></div>

<script>
(() => {
  const DEFAULT_COUNT = 20; // fixed (no UI)

  // No repeats within or across worksheets (per selected problem type).
  // Note: if the pool for a mode is exhausted, the app will ask you to switch modes or reload.
    // No repeats within or across worksheets (per selected problem type).
  // This is persisted to localStorage so reloads will NOT reintroduce repeats.
  // If the pool for a mode is exhausted, use a different mode or Clear History.
  const usedByMode = Object.create(null); // { [typeKey]: Set<string> }
  const MAX_UNIQUE_TRIES = 4000;
  const STORAGE_KEY = "MP_USED_PROBLEMS_V1";
  let saveTimer = null;
  let dirtySave = false;

  (function initUsedFromStorage(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return;
      for (const [k, arr] of Object.entries(obj)) {
        if (!Array.isArray(arr)) continue;
        usedByMode[k] = new Set(arr.filter(x => typeof x === "string"));
      }
    } catch {}
  })();

  function scheduleSaveUsed(){
    dirtySave = true;
    if (saveTimer) return;
    saveTimer = setTimeout(() => {
      saveTimer = null;
      if (!dirtySave) return;
      dirtySave = false;
      try {
        const out = {};
        for (const [k, set] of Object.entries(usedByMode)) {
          if (set && set.size) out[k] = Array.from(set);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
      } catch {}
    }, 300);
  }


  const TYPES = {
    add_easy: {
      label: "Addition – easy",
      desc: "Add within 20 (mostly no carry).",
      ops: ["add"],
      a: [0, 20], b: [0, 20], carry: "mostly_no",
      mastery: { acc: 0.92, time: 10 }
    },
    add_hard: {
      label: "Addition – difficult",
      desc: "2–3 digit addition (carry allowed).",
      ops: ["add"],
      a: [10, 999], b: [10, 999], carry: "auto",
      mastery: { acc: 0.88, time: 14 }
    },
    sub_easy: {
      label: "Subtraction – easy",
      desc: "Subtract within 20 (mostly no borrow).",
      ops: ["sub"],
      a: [0, 20], b: [0, 20], borrow: "mostly_no",
      mastery: { acc: 0.92, time: 11 }
    },
    sub_hard: {
      label: "Subtraction – difficult",
      desc: "2–3 digit subtraction (borrow allowed).",
      ops: ["sub"],
      a: [10, 999], b: [10, 999], borrow: "auto",
      mastery: { acc: 0.88, time: 15 }
    },
    mul_easy: {
      label: "Multiplication – easy",
      desc: "Times tables (0–12).",
      ops: ["mul"],
      a: [0, 12], b: [0, 12],
      mastery: { acc: 0.90, time: 11 }
    },
    mul_hard: {
      label: "Multiplication – difficult",
      desc: "2-digit × 1-digit.",
      ops: ["mul"],
      a: [10, 99], b: [2, 9],
      mastery: { acc: 0.88, time: 15 }
    },
    div_easy: {
      label: "Division – easy",
      desc: "Exact division using facts (no remainders).",
      ops: ["div"],
      divisor: [2, 12], quotient: [0, 12],
      mastery: { acc: 0.90, time: 13 }
    },
    div_hard: {
      label: "Division – difficult",
      desc: "Exact division with larger divisors.",
      ops: ["div"],
      divisor: [10, 49], quotient: [2, 20],
      mastery: { acc: 0.88, time: 17 }
    },
    mix_easy: {
      label: "Mix – easy",
      desc: "Mixed +/− within 20 and ×/÷ facts.",
      ops: ["add_easy", "sub_easy", "mul_easy", "div_easy"],
      mastery: { acc: 0.90, time: 13 }
    },
    mix_hard: {
      label: "Mix – difficult",
      desc: "Mixed 2–3 digit +/− and 2-digit × 1-digit and larger ÷ (exact).",
      ops: ["add_hard", "sub_hard", "mul_hard", "div_hard"],
      mastery: { acc: 0.88, time: 17 }
    },
  };

  const state = {
    current: null,
    started: false,
    setTarget: DEFAULT_COUNT,
    setDone: 0,
    correct: 0,
    total: 0,
    streak: 0,
    perProblemTimes: [],
    problemStartTs: null,
    sessionStartTs: Date.now(),
    lastLayout: "Mixed",
  };

  const el = {
    ptype: document.getElementById('ptype'),
    startBtn: document.getElementById('startBtn'),
    printBtn: document.getElementById('printBtn'),
    clearHistoryBtn: document.getElementById('clearHistoryBtn'),

    eqH: document.getElementById('equationHorizontal'),
    eqVWrap: document.getElementById('equationVerticalWrap'),
    vTop: document.getElementById('vTop'),
    vBottom: document.getElementById('vBottom'),
    vOp: document.getElementById('vOp'),

    answer: document.getElementById('answer'),
    checkBtn: document.getElementById('checkBtn'),
    nextBtn: document.getElementById('nextBtn'),
    feedback: document.getElementById('feedback'),

    statProgress: document.getElementById('statProgress'),
    statStreak: document.getElementById('statStreak'),
    statAccuracy: document.getElementById('statAccuracy'),
    statAvgTime: document.getElementById('statAvgTime'),
    statLayout: document.getElementById('statLayout'),
    statMastery: document.getElementById('statMastery'),
    sessionClock: document.getElementById('sessionClock'),
    clockNow: document.getElementById('clockNow'),

    printArea: document.getElementById('printArea'),
  };

  const randInt = (min, maxInclusive) => Math.floor(Math.random() * (maxInclusive - min + 1)) + min;

  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  }
  function safeFocusAnswer() {
    setTimeout(() => {
      try { el.answer.focus({ preventScroll: true }); }
      catch { el.answer.focus(); }
    }, isIOS() ? 50 : 0);
  }

  function computeAvgTime() {
    if (!state.perProblemTimes.length) return 0;
    const sum = state.perProblemTimes.reduce((a,b) => a + b, 0);
    return sum / state.perProblemTimes.length;
  }

  function setFeedback(msg, kind) {
    el.feedback.textContent = msg || '';
    el.feedback.className = 'feedback ' + (kind || '');
  }

  function getTypeKey() {
    return el.ptype.value || "mix_easy";
  }
  function getTypeObj(key=getTypeKey()) {
    return TYPES[key] || TYPES.mix_easy;
  }

  function getUsedSet(modeKey) {
    if (!usedByMode[modeKey]) usedByMode[modeKey] = new Set();
    return usedByMode[modeKey];
  }

  function signatureForProblem(p) {
    // Normalize commutative ops so 3+5 and 5+3 count as the same problem.
    if (p.type === "add" || p.type === "mul") {
      const x = Math.min(p.a, p.b);
      const y = Math.max(p.a, p.b);
      return `${p.type}|${x}|${y}`;
    }
    return `${p.type}|${p.a}|${p.b}`;
  }

  function generateUniqueProblem(modeKey) {
    const used = getUsedSet(modeKey);
    for (let i = 0; i < MAX_UNIQUE_TRIES; i++) {
      const p = generateProblemFromType(modeKey);
      const sig = signatureForProblem(p);
      if (!used.has(sig)) {
        used.add(sig);
        scheduleSaveUsed();
        return p;
      }
    }
    return null; // likely exhausted
  }

  function updateStats() {
    el.statProgress.textContent = `Worksheet: ${state.setDone}/${state.setTarget}`;
    el.statStreak.textContent = `Streak: ${state.streak}`;
    const acc = state.total ? Math.round((state.correct / state.total) * 100) : 100;
    el.statAccuracy.textContent = `Accuracy: ${acc}%`;
    el.statAvgTime.textContent = `Avg time: ${computeAvgTime().toFixed(1)}s`;
    el.statLayout.textContent = `Layout: ${state.lastLayout}`;

    const mastery = checkMastery(false);
    el.statMastery.textContent = mastery.passed ? "Mastery: PASS" : "Mastery: Not yet";
    el.statMastery.className = "pill " + (mastery.passed ? "ok" : "");
  }

  function digitNoCarry(a, b) {
    let aa = a, bb = b;
    while (aa > 0 || bb > 0) {
      const da = aa % 10, db = bb % 10;
      if (da + db >= 10) return false;
      aa = Math.floor(aa / 10);
      bb = Math.floor(bb / 10);
    }
    return true;
  }
  function digitNoBorrow(a, b) {
    let aa = a, bb = b;
    while (aa > 0 || bb > 0) {
      const da = aa % 10, db = bb % 10;
      if (da < db) return false;
      aa = Math.floor(aa / 10);
      bb = Math.floor(bb / 10);
    }
    return true;
  }

  function generateAdd(cfg) {
    let a, b;
    for (let i = 0; i < 160; i++) {
      a = randInt(cfg.a[0], cfg.a[1]);
      b = randInt(cfg.b[0], cfg.b[1]);
      if (cfg.carry === "no" && !digitNoCarry(a,b)) continue;
      if (cfg.carry === "mostly_no" && Math.random() < 0.75 && !digitNoCarry(a,b)) continue;
      return { a, b, op:"+", type:"add", answer: a + b };
    }
    return { a, b, op:"+", type:"add", answer: a + b };
  }

  function generateSub(cfg) {
    let a, b;
    for (let i = 0; i < 190; i++) {
      a = randInt(cfg.a[0], cfg.a[1]);
      b = randInt(cfg.b[0], cfg.b[1]);
      if (b > a) [a,b] = [b,a];
      if (cfg.borrow === "no" && !digitNoBorrow(a,b)) continue;
      if (cfg.borrow === "mostly_no" && Math.random() < 0.75 && !digitNoBorrow(a,b)) continue;
      return { a, b, op:"−", type:"sub", answer: a - b };
    }
    return { a, b, op:"−", type:"sub", answer: a - b };
  }

  function generateMul(cfg) {
    const a = randInt(cfg.a[0], cfg.a[1]);
    const b = randInt(cfg.b[0], cfg.b[1]);
    return { a, b, op:"×", type:"mul", answer: a * b };
  }

  function generateDiv(cfg) {
    const divisor = randInt(cfg.divisor[0], cfg.divisor[1]);
    const quotient = randInt(cfg.quotient[0], cfg.quotient[1]);
    const dividend = divisor * quotient;
    return { a: dividend, b: divisor, op:"÷", type:"div", answer: quotient };
  }

  function generateProblemFromType(typeKey) {
    const t = getTypeObj(typeKey);

    if (typeKey.startsWith("mix_")) {
      const pick = t.ops[randInt(0, t.ops.length - 1)];
      return generateProblemFromType(pick);
    }

    const op = t.ops[0];
    if (op === "add") return generateAdd(t);
    if (op === "sub") return generateSub(t);
    if (op === "mul") return generateMul(t);
    return generateDiv(t);
  }

  function chooseLayout(problem) {
    const big = (String(problem.a).length >= 4 || String(problem.b).length >= 4);
    if (big) return "horizontal";
    return (Math.random() < 0.55) ? "vertical" : "horizontal";
  }

  function renderProblem(problem) {
    const layout = chooseLayout(problem);
    state.lastLayout = layout === "vertical" ? "Vertical" : "Horizontal";

    el.eqH.style.display = "none";
    el.eqVWrap.style.display = "none";

    if (layout === "horizontal") {
      el.eqH.textContent = `${problem.a} ${problem.op} ${problem.b} =`;
      el.eqH.style.display = "block";
    } else {
      el.vTop.textContent = String(problem.a);
      el.vBottom.textContent = String(problem.b);
      el.vOp.textContent = problem.op;
      el.eqVWrap.style.display = "block";
    }
  }

  function checkMastery(showMessage) {
    const t = getTypeObj();
    const acc = state.total ? (state.correct / state.total) : 1;
    const avg = computeAvgTime();
    const enoughAttempts = state.total >= Math.min(state.setTarget, 10);
    const passed = enoughAttempts && acc >= t.mastery.acc && avg > 0 && avg <= t.mastery.time;

    if (showMessage) {
      if (passed) setFeedback(`Mastery PASS.`, "okText");
      else setFeedback(`Keep going.`, "");
    }
    return { passed, acc, avg };
  }

  function startWorksheet() {
    state.started = true;
    state.setTarget = DEFAULT_COUNT;
    state.setDone = 0;
    state.streak = 0;
    state.perProblemTimes = [];
    state.problemStartTs = null;

    nextProblem(true);
    updateStats();
  }

  function nextProblem(isNewSheet=false) {
    if (!state.started) return;

    if (!isNewSheet && state.setDone >= state.setTarget) {
      checkMastery(true);
      updateStats();

      el.eqH.textContent = "Worksheet done!";
      el.eqH.style.display = "block";
      el.eqVWrap.style.display = "none";
      state.current = null;
      return;
    }

    const modeKey = getTypeKey();
    state.current = generateUniqueProblem(modeKey);

    if (!state.current) {
      el.eqH.textContent = "No more unique problems in this mode. Switch mode or Clear History.";
      el.eqH.style.display = "block";
      el.eqVWrap.style.display = "none";
      setFeedback("", "");
      state.current = null;
      return;
    }
    renderProblem(state.current);

    el.answer.value = "";
    state.problemStartTs = performance.now();
    setFeedback("", "");

    updateStats();
    safeFocusAnswer();
  }

  function checkAnswer() {
    if (!state.current) return;

    const raw = (el.answer.value || "").trim();
    if (!/^-?\d+$/.test(raw)) {
      setFeedback("Type a number.", "badText");
      safeFocusAnswer();
      return;
    }

    const userAns = Number(raw);
    const correctAns = state.current.answer;

    const dt = state.problemStartTs ? (performance.now() - state.problemStartTs) / 1000 : 0;
    state.total += 1;
    state.perProblemTimes.push(dt);

    state.setDone += 1;

    if (userAns === correctAns) {
      state.correct += 1;
      state.streak += 1;
      setFeedback(`Correct.`, "okText");
      updateStats();
      setTimeout(() => nextProblem(false), 260);
    } else {
      state.streak = 0;
      setFeedback(`Answer: ${correctAns}`, "badText");
      updateStats();
      setTimeout(() => nextProblem(false), 520);
    }
  }

  
  function clearHistory() {
    const ok = window.confirm("Clear saved problem history? This allows problems to repeat again.");
    if (!ok) return;

    for (const k of Object.keys(usedByMode)) delete usedByMode[k];
    try { localStorage.removeItem(STORAGE_KEY); } catch {}

    // Reset session stats and worksheet state
    state.current = null;
    state.started = false;
    state.setDone = 0;
    state.correct = 0;
    state.total = 0;
    state.streak = 0;
    state.perProblemTimes = [];
    state.problemStartTs = null;

    el.eqH.style.display = "block";
    el.eqVWrap.style.display = "none";
    el.eqH.textContent = "Press Start";
    el.answer.value = "";
    setFeedback("History cleared.", "");
    updateStats();
    safeFocusAnswer();
  }

// ================= Printable worksheets =================
  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function buildPrintProblems(count) {
    const key = getTypeKey();
    const probs = [];
    for (let i = 0; i < count; i++) {
      const p = generateUniqueProblem(key);
      if (!p) break;
      const printLayout = (Math.random() < 0.40) ? "V" : "H";
      probs.push({ ...p, printLayout });
    }
    return probs;
  }

  function renderPrintProblemHTML(p, idx) {
    if (p.printLayout === "H") {
      const expr = `${p.a} ${p.op} ${p.b} = `;
      return `<div class="pProbH">${idx+1}. ${expr}<span class="pBlank"></span></div>`;
    }

    const top = String(p.a);
    const bottom = String(p.b);
    const op = p.op;

    return `
      <div class="pProbV">
        <div style="opacity:.95; font-size: 11pt; font-weight:800;">${idx+1}.</div>
        <div class="pVRow">${top}</div>
        <div class="pVRow op"><span class="opLeft">${op}</span><span class="numRight">${bottom}</span></div>
        <div class="pVLine"></div>
        <div class="pVAnswer"><span class="pVBlank"></span></div>
      </div>
    `;
  }

  function renderPrintSheet() {
    const t = getTypeObj();
    const count = DEFAULT_COUNT;
    const probs = buildPrintProblems(count);
    const actualCount = probs.length;
    const dateStr = todayISO();
    const rows = probs.map((p, idx) => renderPrintProblemHTML(p, idx)).join("");

    el.printArea.innerHTML = `
      <div class="pSheet">
        <div class="pHeader">
          <div class="pTitle">Math Worksheet</div>
          <div class="pMeta">Date: ${dateStr}<br/>${t.label}</div>
        </div>
        <div class="pLine"></div>
        <div class="pInfo">
          <div>Name: __________________________</div>
          <div>Time: _____________   Score: ______ / ${actualCount}</div>
        </div>
        <div class="pGrid">
          ${rows}
        </div>
        <div class="pFooter">
          <div>${t.label}</div>
          <div>Accuracy first, then speed.</div>
        </div>
      </div>
    `;
  }

  function printWorksheet() {
    renderPrintSheet();
    setTimeout(() => window.print(), 50);
  }

  // Events
  el.startBtn.addEventListener('click', startWorksheet);
  el.checkBtn.addEventListener('click', checkAnswer);
  el.nextBtn.addEventListener('click', () => nextProblem(false));
  el.printBtn.addEventListener('click', printWorksheet);
  el.clearHistoryBtn.addEventListener('click', clearHistory);

  el.ptype.addEventListener('change', () => {
    updateStats();
    if (state.started) startWorksheet();
  });

  // iPad keyboard "Done" support
  el.answer.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') checkAnswer();
  });
  el.answer.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') checkAnswer();
  });

  // Prevent accidental scroll jumps when tapping around on iOS
  document.addEventListener('touchend', (e) => {
    const t = e.target;
    const isInteractive = t && (t.tagName === "BUTTON" || t.tagName === "SELECT" || t.id === "answer" || t.tagName === "INPUT");
    if (!isInteractive && state.started && state.current) safeFocusAnswer();
  }, { passive: true });

  // Session timer (right pill)
  setInterval(() => {
    const s = Math.floor((Date.now() - state.sessionStartTs) / 1000);
    const mm = Math.floor(s / 60);
    const ss = String(s % 60).padStart(2, '0');
    el.sessionClock.textContent = `Session: ${mm}:${ss}`;
  }, 500);

  // Real time clock (top center)
  const fmt = new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" });
  function tickNow() {
    el.clockNow.textContent = `Time: ${fmt.format(new Date())}`;
  }
  tickNow();
  setInterval(tickNow, 1000);

  // Init
  updateStats();
  el.eqH.style.display = "block";
  el.eqH.textContent = "Press Start";
})();
</script>
</body>
</html>
